# ADR-010: Live Detection Screen Design

Status: Accepted
Date: 2026-02-19
Deciders: @owner

## Context

Главный экран приложения должен обеспечивать непрерывный мониторинг аудио с живой лентой обнаруженных птиц. Это отличается от первоначального подхода "одна запись → один результат" и ближе к концепции непрерывного определения из REQUIREMENTS.md (FR-005..FR-008).

## Decision

### Экран: Live Detection (RU: "Определение")

Главный экран приложения — непрерывный анализ аудиопотока с лентой результатов.

### Элементы управления:

- **Start** — начать анализ аудиопотока
- **Pause** — приостановить анализ (не завершить сессию)
- **Stop** — завершить сессию, сохранить все результаты
- **Reset** — очистить текущий список обнаруженных видов, продолжить анализ

### Layout экрана:

```
┌──────────────────────────┐
│  Live Detection    [GPS] │  ← TopBar + индикатор GPS
│                          │
│  ● Анализ...  00:05:32   │  ← статус + таймер сессии
│  ▶ Start  ⏸ Pause  ⏹ Stop│  ← панель управления
│                          │
│── Обнаружено (3) ────────│  ← заголовок списка + счётчик
│                          │
│ ┌──────────────────────┐ │
│ │ Большая синица   92% │ │  ← карточка: вид + confidence
│ │ 14:32 • 8.5 сек      │ │  ← время обнаружения + длительность
│ └──────────────────────┘ │
│ ┌──────────────────────┐ │
│ │ Зяблик           85% │ │
│ │ 14:30 • 5.2 сек      │ │
│ └──────────────────────┘ │
│ ┌──────────────────────┐ │
│ │ Дрозд певчий     88% │ │
│ │ 14:28 • 6.1 сек      │ │
│ └──────────────────────┘ │
│                          │
│         [Reset]          │  ← сброс списка
│                          │
├────────┬────────┬────────┤
│ ● Опр. │ Истор. │ Настр. │  ← Bottom Navigation Bar
└────────┴────────┴────────┘
```

### Состояния экрана:

1. **Idle** — до нажатия Start. Кнопки: [Start]. Список пуст, текст "Нажмите Start для начала"
2. **Analyzing** — идёт анализ. Кнопки: [Pause] [Stop]. Список растёт. Индикатор записи
3. **Paused** — анализ на паузе. Кнопки: [Resume] [Stop]. Список замёр. Можно слушать записи
4. **Stopped** — сессия завершена. Кнопки: [Start] (новая сессия). Результаты сохранены

### Тап на карточку вида → Detail Screen:

```
┌──────────────────────────┐
│  ← Большая синица        │  ← TopBar с кнопкой назад
│                          │
│  Parus major             │  ← научное название
│  Confidence: 92%         │
│                          │
│  ┌────────────────────┐  │
│  │  ▶ advancement bar │  │  ← плеер записанного фрагмента
│  │  0:00 ──●── 0:08   │  │
│  └────────────────────┘  │
│                          │
│  Обнаружен: 14:32        │
│  Длительность: 8.5 сек   │
│  GPS: 53.9°N, 27.6°E     │
│                          │
│  ── Описание ──────────  │
│  (будущее: текст о виде, │
│   фото, ареал обитания)  │
│                          │
└──────────────────────────┘
```

**Важно:** при открытии Detail Screen и нажатии Play — анализ автоматически ставится на паузу (иначе микрофон будет записывать воспроизводимый звук).

### Поток данных при анализе:

```
AudioRecord (непрерывный поток)
    → Chunking (3-5 сек окна)
    → BirdNET TFLite inference
    → Confidence ≥ 80%?
        → ДА: добавить в список + сохранить аудиофрагмент
        → НЕТ: отбросить chunk
    → Обновить UI через StateFlow<List<DetectedBird>>
```

### Формат превью:

Jetpack Compose @Preview. Создаём UI-компоненты с @Preview аннотациями — видны в Android Studio без эмулятора. Этот же код становится продакшн-кодом.

## Consequences

### Positive
- Живая лента — интуитивный UX для мониторинга в поле
- Start/Pause/Stop — полный контроль над сессией
- Каждый обнаруженный вид сохраняется с аудиофрагментом — ценные данные
- Compose @Preview = прототип является финальным кодом

### Negative
- Требуется Foreground Service (обязательно для непрерывной записи на Android 11+)
- Сложнее чем "одна запись → один результат": управление состояниями, chunking, конкурентный доступ к микрофону
- Расход батареи выше при непрерывном анализе
- Автопауза при воспроизведении — дополнительная координация между сервисами

### Neutral
- Список обнаруженных видов хранится в ViewModel (StateFlow), при Stop — batch-сохранение в Room
- Reset очищает только UI-список, уже сохранённые данные не удаляются
- В будущем Detail Screen расширяется справочной информацией (фото, описание, ареал)

## Alternatives Considered

- **Single shot**: нажал → записал 10 сек → один результат. Отклонено: пользователь хочет непрерывный мониторинг, не последовательные записи
- **Auto-scroll лог** (текстовый): результаты как текстовый лог без карточек. Отклонено: менее информативно, нет возможности нажать и углубиться
